<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breakout Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            color: #FFD700;
            font-weight: bold;
        }

        .game-info {
            display: flex;
            gap: 25px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .info-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            min-width: 100px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .lives-display {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .life-ball {
            width: 12px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255,215,0,0.5);
        }

        .game-container {
            position: relative;
            margin-bottom: 20px;
        }

        #gameCanvas {
            border: 3px solid #FFD700;
            background: #000;
            box-shadow: 0 0 30px rgba(255,215,0,0.3);
            border-radius: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid #FFD700;
            background: transparent;
            color: #FFD700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            border-radius: 25px;
        }

        button:hover {
            background: #FFD700;
            color: #000;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mobile-controls {
            display: none;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .mobile-controls button {
            width: 80px;
            height: 60px;
            font-size: 1.2rem;
            padding: 0;
        }

        .launch-btn {
            background: rgba(255,0,0,0.2) !important;
            border-color: #ff0000 !important;
            color: #ff0000 !important;
            width: 120px !important;
        }

        .launch-btn:hover {
            background: #ff0000 !important;
            color: #fff !important;
        }

        .start-screen, .game-over-screen, .level-complete-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .screen-content {
            text-align: center;
            border: 3px solid #FFD700;
            padding: 40px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            box-shadow: 0 0 50px rgba(255,215,0,0.3);
            max-width: 600px;
            margin: 20px;
            border-radius: 15px;
        }

        .screen-content h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            color: #FFD700;
        }

        .screen-content p {
            font-size: 1.1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .block-showcase {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .block-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            border: 1px solid #FFD700;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }

        .block-sample {
            width: 30px;
            height: 15px;
            border-radius: 3px;
        }

        .powerup-showcase {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .powerup-info {
            text-align: center;
            padding: 8px;
            border: 1px solid #FFD700;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            min-width: 80px;
        }

        .game-over-screen, .level-complete-screen {
            display: none;
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .instructions {
            max-width: 900px;
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #FFD700;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .instructions h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #FFD700;
        }

        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .combo-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            display: none;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .game-info {
                gap: 15px;
                font-size: 1rem;
            }
            
            #gameCanvas {
                width: 100%;
                max-width: 400px;
                height: auto;
            }
            
            .mobile-controls {
                display: flex;
            }
            
            .block-showcase {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .screen-content {
                padding: 20px;
                margin: 10px;
            }
            
            .instructions-grid {
                grid-template-columns: 1fr;
            }
            
            .powerup-showcase {
                flex-direction: column;
                align-items: center;
            }
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            pointer-events: none;
            animation: particle 1s ease-out forwards;
        }

        @keyframes particle {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0) translate(var(--dx), var(--dy)); }
        }

        .ball-trail {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            animation: trail 0.3s ease-out forwards;
        }

        @keyframes trail {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.3); }
        }

        .powerup-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            pointer-events: none;
            animation: powerupEffect 2s ease-out forwards;
        }

        @keyframes powerupEffect {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>🧱 BREAKOUT</h1>
        
        <div class="game-info">
            <div class="info-item">
                SCORE: <span id="scoreDisplay">0</span>
            </div>
            <div class="info-item">
                HIGH: <span id="highScoreDisplay">0</span>
            </div>
            <div class="info-item">
                LEVEL: <span id="levelDisplay">1</span>
            </div>
            <div class="info-item">
                LIVES: <div class="lives-display" id="livesDisplay"></div>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="combo-indicator" id="comboIndicator">COMBO x2</div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="pause-overlay" id="pauseOverlay">
            PAUSED
        </div>
        
        <div class="mobile-controls">
            <button id="leftBtn">←</button>
            <button id="rightBtn">→</button>
            <button id="launchBtn" class="launch-btn">LANZAR</button>
        </div>
    </div>

    <div class="controls">
        <button onclick="startGame()" id="startBtn">INICIAR</button>
        <button onclick="togglePause()" id="pauseBtn" disabled>PAUSA</button>
        <button onclick="resetGame()">REINICIAR</button>
    </div>

    <div class="start-screen" id="startScreen">
        <div class="screen-content">
            <h2>🧱 BREAKOUT</h2>
            <p>Destruye todos los bloques con la pelota rebotante</p>
            
            <div class="block-showcase">
                <div class="block-info">
                    <div class="block-sample" style="background: #ff0000;"></div>
                    <div>Rojo<br>7 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #ffa500;"></div>
                    <div>Naranja<br>5 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #ffff00;"></div>
                    <div>Amarillo<br>3 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #00ff00;"></div>
                    <div>Verde<br>1 pt</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #0000ff;"></div>
                    <div>Azul<br>10 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #800080;"></div>
                    <div>Púrpura<br>15 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #c0c0c0;"></div>
                    <div>Plateado<br>25 pts</div>
                </div>
                <div class="block-info">
                    <div class="block-sample" style="background: #ffd700;"></div>
                    <div>Dorado<br>50 pts</div>
                </div>
            </div>
            
            <div class="powerup-showcase">
                <div class="powerup-info">↔️<br>Expandir</div>
                <div class="powerup-info">⚪<br>Multi-ball</div>
                <div class="powerup-info">🐌<br>Lento</div>
                <div class="powerup-info">⚡<br>Rápido</div>
                <div class="powerup-info">❤️<br>Vida</div>
            </div>
            
            <p>Usa las flechas o mouse para mover la paleta</p>
            <button onclick="startGame()">COMENZAR DESTRUCCIÓN</button>
        </div>
    </div>

    <div class="game-over-screen" id="gameOverScreen">
        <div class="screen-content">
            <h2>GAME OVER</h2>
            <p>Los bloques han resistido tu ataque</p>
            <p>Puntuación Final: <span id="finalScore">0</span></p>
            <p>Nivel Alcanzado: <span id="finalLevel">1</span></p>
            <p>Bloques Destruidos: <span id="blocksDestroyed">0</span></p>
            <p id="newRecordText" style="display: none; color: #FFD700;">
                ¡NUEVO RECORD!
            </p>
            <button onclick="playAgain()">INTENTAR DE NUEVO</button>
        </div>
    </div>

    <div class="level-complete-screen" id="levelCompleteScreen">
        <div class="screen-content">
            <h2>¡NIVEL COMPLETADO!</h2>
            <p>¡Todos los bloques han sido destruidos!</p>
            <p>Bonus de Nivel: <span id="levelBonus">1000</span> puntos</p>
            <p>Bonus de Vidas: <span id="livesBonus">0</span> puntos</p>
            <button onclick="nextLevel()">SIGUIENTE NIVEL</button>
        </div>
    </div>

    <div class="instructions">
        <div class="instructions-grid">
            <div>
                <h3>🎯 OBJETIVO</h3>
                <p>Destruye todos los bloques de colores usando la pelota. Controla la paleta para mantener la pelota en juego y dirigir sus rebotes.</p>
            </div>
            <div>
                <h3>🎮 CONTROLES</h3>
                <p><strong>Desktop:</strong> Flechas, A/D o mouse<br>
                <strong>Mobile:</strong> Botones o deslizar<br>
                <strong>Espacio:</strong> Lanzar pelota<br>
                <strong>P:</strong> Pausar</p>
            </div>
            <div>
                <h3>🧱 BLOQUES</h3>
                <p>Diferentes colores valen distintos puntos. Algunos requieren múltiples golpes. Los dorados son indestructibles.</p>
            </div>
            <div>
                <h3>🎁 POWER-UPS</h3>
                <p>Caen de bloques destruidos. Expandir paleta, multi-pelota, cambiar velocidad, vida extra y más efectos.</p>
            </div>
        </div>
    </div>

    <script>
        // Game constants
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const PADDLE_WIDTH = 100;
        const PADDLE_HEIGHT = 15;
        const BALL_RADIUS = 8;
        const BALL_SPEED = 5;
        const BLOCK_WIDTH = 75;
        const BLOCK_HEIGHT = 25;
        const BLOCK_ROWS = 8;
        const BLOCK_COLS = 10;
        const BLOCK_PADDING = 5;

        // Game variables
        let gameState = 'start'; // start, ready, playing, paused, levelComplete, gameOver
        let score = 0;
        let highScore = localStorage.getItem('breakoutHighScore') || 0;
        let level = 1;
        let lives = 3;
        let combo = 0;
        let blocksDestroyed = 0;
        let animationId = null;

        // Game objects
        const paddle = {
            x: canvas.width / 2 - PADDLE_WIDTH / 2,
            y: canvas.height - 40,
            width: PADDLE_WIDTH,
            height: PADDLE_HEIGHT,
            speed: 8,
            originalWidth: PADDLE_WIDTH
        };

        let balls = [];
        let blocks = [];
        let powerups = [];
        let particles = [];
        let activePowerups = [];

        // Input handling
        const keys = {
            left: false,
            right: false,
            space: false
        };

        let mouseX = canvas.width / 2;
        let mouseControl = false;

        // Initialize
        document.getElementById('highScoreDisplay').textContent = highScore;
        updateDisplay();
        setupControls();
        gameLoop();

        function setupControls() {
            // Keyboard controls
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Mouse controls
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('click', handleClick);
            
            // Mobile controls
            document.getElementById('leftBtn').addEventListener('touchstart', () => keys.left = true);
            document.getElementById('leftBtn').addEventListener('touchend', () => keys.left = false);
            document.getElementById('rightBtn').addEventListener('touchstart', () => keys.right = true);
            document.getElementById('rightBtn').addEventListener('touchend', () => keys.right = false);
            document.getElementById('launchBtn').addEventListener('click', launchBall);
            
            // Mouse controls for desktop
            document.getElementById('leftBtn').addEventListener('mousedown', () => keys.left = true);
            document.getElementById('leftBtn').addEventListener('mouseup', () => keys.left = false);
            document.getElementById('rightBtn').addEventListener('mousedown', () => keys.right = true);
            document.getElementById('rightBtn').addEventListener('mouseup', () => keys.right = false);
            
            // Touch controls for paddle
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchstart', handleTouchStart);
        }

        function handleKeyDown(event) {
            if (gameState === 'gameOver' && event.code === 'Enter') {
                playAgain();
                return;
            }
            
            if (event.code === 'KeyP') {
                togglePause();
                return;
            }
            
            switch(event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    event.preventDefault();
                    keys.left = true;
                    mouseControl = false;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    event.preventDefault();
                    keys.right = true;
                    mouseControl = false;
                    break;
                case 'Space':
                    event.preventDefault();
                    if (gameState === 'ready') {
                        launchBall();
                    }
                    break;
            }
        }

        function handleKeyUp(event) {
            switch(event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    keys.left = false;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    keys.right = false;
                    break;
            }
        }

        function handleMouseMove(event) {
            const rect = canvas.getBoundingClientRect();
            mouseX = event.clientX - rect.left;
            mouseControl = true;
        }

        function handleClick(event) {
            if (gameState === 'ready') {
                launchBall();
            }
        }

        function handleTouchMove(event) {
            event.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches[0];
            mouseX = touch.clientX - rect.left;
            mouseControl = true;
        }

        function handleTouchStart(event) {
            event.preventDefault();
            if (gameState === 'ready') {
                launchBall();
            }
        }

        function startGame() {
            gameState = 'ready';
            score = 0;
            level = 1;
            lives = 3;
            combo = 0;
            blocksDestroyed = 0;
            
            resetPaddle();
            createLevel();
            createBall();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('levelCompleteScreen').style.display = 'none';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            
            updateDisplay();
            trackEvent('game_start');
        }

        function resetPaddle() {
            paddle.x = canvas.width / 2 - paddle.width / 2;
            paddle.width = paddle.originalWidth;
            activePowerups = [];
        }

        function createLevel() {
            blocks = [];
            const patterns = [
                // Level 1 - Basic rows
                [
                    'RRRRRRRRRR',
                    'OOOOOOOOOO',
                    'YYYYYYYYYY',
                    'GGGGGGGGGG',
                    '          ',
                    '          ',
                    '          ',
                    '          '
                ],
                // Level 2 - Pyramid
                [
                    '    RR    ',
                    '   OOOO   ',
                    '  YYYYYY  ',
                    ' GGGGGGGG ',
                    'BBBBBBBBBB',
                    '          ',
                    '          ',
                    '          '
                ],
                // Level 3 - Fortress
                [
                    'SSSSSSSSSS',
                    'S        S',
                    'S RRRRRR S',
                    'S R    R S',
                    'S R GG R S',
                    'S RRRRRR S',
                    'S        S',
                    'SSSSSSSSSS'
                ]
            ];
            
            const pattern = patterns[Math.min(level - 1, patterns.length - 1)] || patterns[patterns.length - 1];
            
            for (let row = 0; row < BLOCK_ROWS; row++) {
                for (let col = 0; col < BLOCK_COLS; col++) {
                    const char = pattern[row] ? pattern[row][col] : ' ';
                    if (char !== ' ') {
                        const blockType = getBlockType(char);
                        if (blockType) {
                            blocks.push({
                                x: col * (BLOCK_WIDTH + BLOCK_PADDING) + BLOCK_PADDING,
                                y: row * (BLOCK_HEIGHT + BLOCK_PADDING) + 50,
                                width: BLOCK_WIDTH,
                                height: BLOCK_HEIGHT,
                                ...blockType,
                                maxHits: blockType.hits
                            });
                        }
                    }
                }
            }
        }

        function getBlockType(char) {
            const types = {
                'R': { hits: 1, points: 7, color: '#ff0000' },
                'O': { hits: 1, points: 5, color: '#ffa500' },
                'Y': { hits: 1, points: 3, color: '#ffff00' },
                'G': { hits: 1, points: 1, color: '#00ff00' },
                'B': { hits: 2, points: 10, color: '#0000ff' },
                'P': { hits: 2, points: 15, color: '#800080' },
                'S': { hits: 3, points: 25, color: '#c0c0c0' },
                'D': { hits: 0, points: 50, color: '#ffd700', indestructible: true }
            };
            return types[char];
        }

        function createBall() {
            balls = [{
                x: paddle.x + paddle.width / 2,
                y: paddle.y - BALL_RADIUS - 5,
                dx: 0,
                dy: 0,
                radius: BALL_RADIUS,
                speed: BALL_SPEED,
                onPaddle: true
            }];
        }

        function launchBall() {
            if (gameState === 'ready') {
                gameState = 'playing';
                balls.forEach(ball => {
                    if (ball.onPaddle) {
                        ball.onPaddle = false;
                        ball.dx = (Math.random() - 0.5) * 4;
                        ball.dy = -ball.speed;
                    }
                });
            }
        }

        function togglePause() {
            if (gameState === 'playing') {
                gameState = 'paused';
                document.getElementById('pauseOverlay').style.display = 'flex';
                document.getElementById('pauseBtn').textContent = 'REANUDAR';
            } else if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pauseOverlay').style.display = 'none';
                document.getElementById('pauseBtn').textContent = 'PAUSA';
            }
        }

        function resetGame() {
            gameState = 'start';
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = 'PAUSA';
            document.getElementById('pauseOverlay').style.display = 'none';
        }

        function gameLoop() {
            if (gameState === 'playing') {
                update();
            }
            draw();
            animationId = requestAnimationFrame(gameLoop);
        }

        function update() {
            // Update paddle
            updatePaddle();
            
            // Update balls
            updateBalls();
            
            // Update powerups
            updatePowerups();
            
            // Update particles
            updateParticles();
            
            // Update active powerup effects
            updateActivePowerups();
            
            // Check win condition
            if (blocks.filter(block => !block.indestructible).length === 0) {
                levelComplete();
            }
        }

        function updatePaddle() {
            if (mouseControl) {
                paddle.x = mouseX - paddle.width / 2;
            } else {
                if (keys.left && paddle.x > 0) {
                    paddle.x -= paddle.speed;
                }
                if (keys.right && paddle.x < canvas.width - paddle.width) {
                    paddle.x += paddle.speed;
                }
            }
            
            // Keep paddle in bounds
            paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, paddle.x));
        }

        function updateBalls() {
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                
                if (ball.onPaddle) {
                    ball.x = paddle.x + paddle.width / 2;
                    ball.y = paddle.y - ball.radius - 5;
                    continue;
                }
                
                // Move ball
                ball.x += ball.dx;
                ball.y += ball.dy;
                
                // Create trail effect
                createTrail(ball.x, ball.y);
                
                // Wall collisions
                if (ball.x <= ball.radius || ball.x >= canvas.width - ball.radius) {
                    ball.dx = -ball.dx;
                    ball.x = Math.max(ball.radius, Math.min(canvas.width - ball.radius, ball.x));
                }
                
                if (ball.y <= ball.radius) {
                    ball.dy = -ball.dy;
                    ball.y = ball.radius;
                }
                
                // Paddle collision
                if (ball.y + ball.radius >= paddle.y &&
                    ball.x >= paddle.x && ball.x <= paddle.x + paddle.width &&
                    ball.dy > 0) {
                    
                    // Calculate bounce angle based on hit position
                    const hitPos = (ball.x - paddle.x) / paddle.width;
                    const bounceAngle = (hitPos - 0.5) * Math.PI / 3; // Max 60 degrees
                    
                    const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                    ball.dx = Math.sin(bounceAngle) * speed;
                    ball.dy = -Math.abs(Math.cos(bounceAngle) * speed);
                    
                    ball.y = paddle.y - ball.radius;
                }
                
                // Block collisions
                checkBlockCollisions(ball);
                
                // Ball lost
                if (ball.y > canvas.height) {
                    balls.splice(i, 1);
                }
            }
            
            // Check if all balls lost
            if (balls.length === 0) {
                lives--;
                combo = 0;
                updateDisplay();
                
                if (lives <= 0) {
                    gameOver();
                } else {
                    gameState = 'ready';
                    createBall();
                }
            }
        }

        function checkBlockCollisions(ball) {
            for (let i = blocks.length - 1; i >= 0; i--) {
                const block = blocks[i];
                
                if (ball.x + ball.radius >= block.x &&
                    ball.x - ball.radius <= block.x + block.width &&
                    ball.y + ball.radius >= block.y &&
                    ball.y - ball.radius <= block.y + block.height) {
                    
                    // Calculate bounce direction
                    const ballCenterX = ball.x;
                    const ballCenterY = ball.y;
                    const blockCenterX = block.x + block.width / 2;
                    const blockCenterY = block.y + block.height / 2;
                    
                    const deltaX = Math.abs(ballCenterX - blockCenterX);
                    const deltaY = Math.abs(ballCenterY - blockCenterY);
                    
                    if (deltaX > deltaY) {
                        ball.dx = -ball.dx;
                    } else {
                        ball.dy = -ball.dy;
                    }
                    
                    // Damage block
                    if (!block.indestructible) {
                        block.hits--;
                        
                        if (block.hits <= 0) {
                            // Block destroyed
                            score += block.points * Math.max(1, combo);
                            combo++;
                            blocksDestroyed++;
                            
                            createParticles(block.x + block.width / 2, block.y + block.height / 2, block.color);
                            
                            // Chance to spawn powerup
                            if (Math.random() < 0.15) {
                                spawnPowerup(block.x + block.width / 2, block.y + block.height / 2);
                            }
                            
                            blocks.splice(i, 1);
                            updateDisplay();
                            
                            // Show combo indicator
                            if (combo > 1) {
                                showComboIndicator();
                            }
                        } else {
                            // Block damaged, change color
                            const alpha = block.hits / block.maxHits;
                            block.color = adjustColorAlpha(block.color, alpha);
                        }
                    }
                    
                    break;
                }
            }
        }

        function spawnPowerup(x, y) {
            const powerupTypes = [
                { type: 'expand', color: '#00ff00', symbol: '↔️', effect: 'expandPaddle' },
                { type: 'shrink', color: '#ff0000', symbol: '↔️', effect: 'shrinkPaddle' },
                { type: 'multiball', color: '#ffff00', symbol: '⚪', effect: 'multiball' },
                { type: 'slow', color: '#0000ff', symbol: '🐌', effect: 'slowBall' },
                { type: 'fast', color: '#ff00ff', symbol: '⚡', effect: 'fastBall' },
                { type: 'life', color: '#ffd700', symbol: '❤️', effect: 'extraLife' }
            ];
            
            const powerup = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
            
            powerups.push({
                x: x - 10,
                y: y,
                width: 20,
                height: 20,
                dy: 2,
                ...powerup
            });
        }

        function updatePowerups() {
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                powerup.y += powerup.dy;
                
                // Check paddle collision
                if (powerup.y + powerup.height >= paddle.y &&
                    powerup.x + powerup.width >= paddle.x &&
                    powerup.x <= paddle.x + paddle.width) {
                    
                    applyPowerup(powerup);
                    powerups.splice(i, 1);
                    continue;
                }
                
                // Remove if off screen
                if (powerup.y > canvas.height) {
                    powerups.splice(i, 1);
                }
            }
        }

        function applyPowerup(powerup) {
            score += 100;
            
            switch(powerup.effect) {
                case 'expandPaddle':
                    paddle.width = Math.min(150, paddle.width + 30);
                    addActivePowerup('Paleta Expandida', 10000);
                    break;
                case 'shrinkPaddle':
                    paddle.width = Math.max(50, paddle.width - 30);
                    addActivePowerup('Paleta Encogida', 10000);
                    break;
                case 'multiball':
                    for (let i = 0; i < 2; i++) {
                        const newBall = {
                            x: balls[0].x,
                            y: balls[0].y,
                            dx: (Math.random() - 0.5) * 8,
                            dy: -BALL_SPEED,
                            radius: BALL_RADIUS,
                            speed: BALL_SPEED,
                            onPaddle: false
                        };
                        balls.push(newBall);
                    }
                    showPowerupEffect('Multi-Ball!');
                    break;
                case 'slowBall':
                    balls.forEach(ball => {
                        const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                        const newSpeed = Math.max(2, speed * 0.7);
                        ball.dx = (ball.dx / speed) * newSpeed;
                        ball.dy = (ball.dy / speed) * newSpeed;
                    });
                    addActivePowerup('Pelota Lenta', 8000);
                    break;
                case 'fastBall':
                    balls.forEach(ball => {
                        const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                        const newSpeed = Math.min(8, speed * 1.3);
                        ball.dx = (ball.dx / speed) * newSpeed;
                        ball.dy = (ball.dy / speed) * newSpeed;
                    });
                    addActivePowerup('Pelota Rápida', 8000);
                    break;
                case 'extraLife':
                    lives++;
                    showPowerupEffect('Vida Extra!');
                    break;
            }
            
            updateDisplay();
        }

        function addActivePowerup(name, duration) {
            activePowerups.push({
                name: name,
                timeLeft: duration
            });
            showPowerupEffect(name);
        }

        function updateActivePowerups() {
            for (let i = activePowerups.length - 1; i >= 0; i--) {
                activePowerups[i].timeLeft -= 16; // Assuming 60fps
                
                if (activePowerups[i].timeLeft <= 0) {
                    // Reset paddle size when powerup expires
                    if (activePowerups[i].name.includes('Paleta')) {
                        paddle.width = paddle.originalWidth;
                    }
                    activePowerups.splice(i, 1);
                }
            }
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * 10,
                    dy: (Math.random() - 0.5) * 10,
                    life: 30,
                    maxLife: 30,
                    color: color
                });
            }
        }

        function createTrail(x, y) {
            if (Math.random() < 0.3) {
                particles.push({
                    x: x,
                    y: y,
                    dx: 0,
                    dy: 0,
                    life: 10,
                    maxLife: 10,
                    color: '#ffffff',
                    isTrail: true
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.life--;
                
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function showComboIndicator() {
            const indicator = document.getElementById('comboIndicator');
            indicator.textContent = `COMBO x${combo}`;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 1000);
        }

        function showPowerupEffect(text) {
            const effect = document.createElement('div');
            effect.className = 'powerup-effect';
            effect.textContent = text;
            document.querySelector('.game-container').appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 2000);
        }

        function adjustColorAlpha(color, alpha) {
            // Simple color darkening for damaged blocks
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            
            const newR = Math.floor(r * alpha);
            const newG = Math.floor(g * alpha);
            const newB = Math.floor(b * alpha);
            
            return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
        }

        function levelComplete() {
            gameState = 'levelComplete';
            
            const levelBonus = 1000;
            const livesBonus = lives * 500;
            score += levelBonus + livesBonus;
            
            document.getElementById('levelBonus').textContent = levelBonus;
            document.getElementById('livesBonus').textContent = livesBonus;
            document.getElementById('levelCompleteScreen').style.display = 'flex';
            
            updateDisplay();
            trackEvent('level_complete', { level, bonus: levelBonus + livesBonus });
        }

        function nextLevel() {
            level++;
            combo = 0;
            
            resetPaddle();
            createLevel();
            createBall();
            
            document.getElementById('levelCompleteScreen').style.display = 'none';
            gameState = 'ready';
            
            updateDisplay();
        }

        function gameOver() {
            gameState = 'gameOver';
            
            // Check for new high score
            const isNewRecord = score > highScore;
            if (isNewRecord) {
                highScore = score;
                localStorage.setItem('breakoutHighScore', highScore);
                document.getElementById('highScoreDisplay').textContent = highScore;
                document.getElementById('newRecordText').style.display = 'block';
            } else {
                document.getElementById('newRecordText').style.display = 'none';
            }
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLevel').textContent = level;
            document.getElementById('blocksDestroyed').textContent = blocksDestroyed;
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('pauseBtn').disabled = true;
            
            trackEvent('game_over', { score, level, blocksDestroyed, newRecord: isNewRecord });
        }

        function playAgain() {
            document.getElementById('gameOverScreen').style.display = 'none';
            startGame();
        }

        function draw() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw blocks
            drawBlocks();
            
            // Draw paddle
            drawPaddle();
            
            // Draw balls
            drawBalls();
            
            // Draw powerups
            drawPowerups();
            
            // Draw particles
            drawParticles();
        }

        function drawBlocks() {
            blocks.forEach(block => {
                ctx.fillStyle = block.color;
                ctx.fillRect(block.x, block.y, block.width, block.height);
                
                // Block border
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(block.x, block.y, block.width, block.height);
                
                // Show hits remaining for multi-hit blocks
                if (block.maxHits > 1) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(block.hits, block.x + block.width / 2, block.y + block.height / 2 + 4);
                }
            });
        }

        function drawPaddle() {
            // Paddle gradient
            const gradient = ctx.createLinearGradient(paddle.x, paddle.y, paddle.x, paddle.y + paddle.height);
            gradient.addColorStop(0, '#FFD700');
            gradient.addColorStop(1, '#FFA500');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
            
            // Paddle border
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(paddle.x, paddle.y, paddle.width, paddle.height);
        }

        function drawBalls() {
            balls.forEach(ball => {
                // Ball gradient
                const gradient = ctx.createRadialGradient(ball.x - 3, ball.y - 3, 0, ball.x, ball.y, ball.radius);
                gradient.addColorStop(0, '#fff');
                gradient.addColorStop(1, '#ccc');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Ball border
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        function drawPowerups() {
            powerups.forEach(powerup => {
                ctx.fillStyle = powerup.color;
                ctx.fillRect(powerup.x, powerup.y, powerup.width, powerup.height);
                
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(powerup.symbol, powerup.x + powerup.width / 2, powerup.y + powerup.height / 2 + 4);
            });
        }

        function drawParticles() {
            particles.forEach(particle => {
                const alpha = particle.life / particle.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = particle.color;
                
                if (particle.isTrail) {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillRect(particle.x - 2, particle.y - 2, 4, 4);
                }
                
                ctx.restore();
            });
        }

        function updateDisplay() {
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('levelDisplay').textContent = level;
            
            // Update lives display
            const livesDisplay = document.getElementById('livesDisplay');
            livesDisplay.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const life = document.createElement('div');
                life.className = 'life-ball';
                livesDisplay.appendChild(life);
            }
        }

        function trackEvent(eventType, data = {}) {
            const event = {
                game: 'breakout',
                type: eventType,
                timestamp: new Date().toISOString(),
                data: data
            };
            
            fetch('/analytics/event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(event)
            }).catch(err => {
                const events = JSON.parse(localStorage.getItem('breakoutEvents') || '[]');
                events.push(event);
                localStorage.setItem('breakoutEvents', JSON.stringify(events));
            });
        }
    </script>
</body>
</html>